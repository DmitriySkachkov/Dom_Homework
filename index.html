<!DOCTYPE html>
<html>
  <head>
    <title>Проект "Комменты"</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="styles.css" />
  </head>

  <body>
     <div class="container">
      <div class="comments-container">
        <div id="loading" class="loading">Загрузка комментариев...</div>
        <ul class="comments" style="display: none;">
        </ul>
      </div>
      <div class="add-form">
        <input
          type="text"
          class="add-form-name"
          placeholder="Введите ваше имя"
        />
        <textarea
          type="textarea"
          class="add-form-text"
          placeholder="Введите ваш комментарий"
          rows="4"
        ></textarea>
        <div class="add-form-row">
          <button class="add-form-button">Написать</button>
        </div>
      </div>
    </div>
  </body>

  <script>
    const host = "https://wedev-api.sky.pro/api/v1/dmitriy-skachkov";

    function delay(interval = 300) {
      return new Promise((resolve) => {
        setTimeout(() => {
          resolve();
        }, interval);
      });
    }

    function loadComments() {
      return fetch(host + "/comments")
        .then((response) => {
          if (!response.ok) {
            throw new Error('Ошибка загрузки комментариев');
          }
          return response.json();
        })
        .then((data) => {
          return data.comments.map(comment => {
            return {
              id: comment.id,
              name: comment.author.name,
              date: new Date(comment.date),
              text: comment.text,
              likes: comment.likes,
              isLiked: false,
              isLikeLoading: false
            };
          });
        });
    }

    const postComment = (name, text) => {
      return fetch(host + "/comments", {
        method: "POST",
        body: JSON.stringify({
          text: text,
          name: name,
        }),
      })
        .then((response) => {
          if (!response.ok) {
            return response.text().then(errorText => {
              throw new Error(`Ошибка сервера: ${response.status} ${errorText}`);
            });
          }
          return response.json();
        });
    };

    let comments = [];
    let replyingToCommentId = null;

    const nameInput = document.querySelector('.add-form-name');
    const textInput = document.querySelector('.add-form-text');
    const addButton = document.querySelector('.add-form-button');
    const commentsList = document.querySelector('.comments');
    const loadingElement = document.getElementById('loading');

    function escapeHtml(unsafe) {
      if (!unsafe) return '';
      return unsafe
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#039;');
    }

    function updateComments(newComments) {
      comments = newComments;
    }

    function renderComments() {
      let commentsHTML = '';
      
      comments.forEach((comment) => {
        const formattedDate = comment.date instanceof Date 
          ? comment.date.toLocaleDateString('ru-RU', {
              day: '2-digit',
              month: '2-digit',
              year: '2-digit',
              hour: '2-digit',
              minute: '2-digit'
            })
          : comment.date;
        
        const likeButtonClass = comment.isLiked ? '-active-like' : '';
        const loadingClass = comment.isLikeLoading ? '-loading-like' : '';
        
        commentsHTML += `
          <li class="comment" data-id="${comment.id}">
            <div class="comment-header">
              <div>${escapeHtml(comment.name)}</div>
              <div>${formattedDate}</div>
            </div>
            <div class="comment-body">
              <div class="comment-text">
                ${escapeHtml(comment.text)}
              </div>
            </div>
            <div class="comment-footer">
              <div class="likes">
                <span class="likes-counter">${comment.likes}</span>
                <button class="like-button ${likeButtonClass} ${loadingClass}" 
                        data-id="${comment.id}"
                        ${comment.isLikeLoading ? 'disabled' : ''}>
                </button>
              </div>
            </div>
          </li>
        `;
      });
      
      commentsList.innerHTML = commentsHTML;
      
      document.querySelectorAll('.like-button').forEach((button) => {
        button.addEventListener('click', (event) => {
          event.stopPropagation();
          const commentId = parseInt(event.target.dataset.id);
          toggleLike(commentId);
        });
      });
      
      document.querySelectorAll('.comment').forEach((commentElement) => {
        commentElement.addEventListener('click', (event) => {
          if (!event.target.closest('.like-button')) {
            const commentId = parseInt(commentElement.dataset.id);
            replyToComment(commentId);
          }
        });
      });
    }

    function toggleLike(commentId) {
      const comment = comments.find(c => c.id === commentId);
      
      if (comment && !comment.isLikeLoading) {
        comment.isLikeLoading = true;
        renderComments();
        
        delay(2000)
          .then(() => {
            comment.likes = comment.isLiked ? comment.likes - 1 : comment.likes + 1;
            comment.isLiked = !comment.isLiked;
            comment.isLikeLoading = false;
            return comment;
          })
          .then(() => {
            renderComments();
          })
          .catch((error) => {
            console.error('Ошибка при установке лайка:', error);
            comment.isLikeLoading = false;
            renderComments();
          });
      }
    }

    function replyToComment(commentId) {
      const comment = comments.find(c => c.id === commentId);
      
      if (comment) {
        replyingToCommentId = commentId;
        
        const replyText = `> ${comment.name}:\n> ${comment.text}\n\n`;
        
        nameInput.value = comment.name;
        textInput.value = replyText;
        
        textInput.focus();
      }
    }

    function addNewComment() {
      const name = nameInput.value.trim();
      let text = textInput.value.trim();
      
      if (!name || !text) {
        alert('Пожалуйста, заполните все поля');
        return;
      }
      
      const originalText = addButton.textContent;
      addButton.disabled = true;
      addButton.textContent = 'Добавляем...';
      
      postComment(name, text)
        .then(() => {
          return loadComments();
        })
        .then((updatedComments) => {
          updateComments(updatedComments);
          renderComments();
          
          nameInput.value = '';
          textInput.value = '';
          replyingToCommentId = null;
        })
        .catch((error) => {
          console.error('Ошибка при добавлении комментария:', error);
          alert(`Не удалось отправить комментарий: ${error.message}`);
        })
        .finally(() => {
          addButton.disabled = false;
          addButton.textContent = originalText;
        });
    }

    function initApp() {
      loadingElement.style.display = 'block';
      commentsList.style.display = 'none';
      
      loadComments()
        .then((commentsData) => {
          updateComments(commentsData);
          return commentsData;
        })
        .then(() => {
          renderComments();
          loadingElement.style.display = 'none';
          commentsList.style.display = 'block';
        })
        .catch((error) => {
          console.error('Ошибка загрузки комментариев:', error);
          loadingElement.textContent = 'Не удалось загрузить комментарии';
          alert('Не удалось загрузить комментарии');
        });
      
      addButton.addEventListener('click', addNewComment);
      
      nameInput.addEventListener('input', function() {
        console.log('Имя изменено:', this.value);
      });
      
      textInput.addEventListener('input', function() {
        console.log('Комментарий изменен:', this.value);
      });
      
      textInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && e.ctrlKey) {
          e.preventDefault();
          addNewComment();
        }
      });
    }

    document.addEventListener('DOMContentLoaded', initApp);

  </script>
</html>